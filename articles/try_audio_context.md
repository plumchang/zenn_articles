---
title: "Web Audio API + React ã§ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ã‚’ä½œã£ã¦ã¿ã‚ˆã†"
emoji: "ğŸ¹"
type: "tech"
topics: ["React", "WebAudioAPI", "AudioContext"]
published: false
publication_name: "milabo"
---

## ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ï¼ä»Šå¹´ï¼ˆ2024å¹´ï¼‰7æœˆã«æ ªå¼ä¼šç¤¾ãƒŸãƒ©ãƒœã«å…¥ç¤¾ã—ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦åƒã„ã¦ã„ã‚‹ æ¢…æ¾¤ ã§ã™ã€‚

å¼Šç¤¾æ¥­å‹™ã®ä¸€ç’°ã§ã€Web Audio API ã®ã“ã¨ã‚’çŸ¥ã‚Šã€èˆˆå‘³ã‚’æŒã£ãŸã®ã§ã€ç§è‡ªèº«ã®çŸ¥è¦‹ã‚’æ·±ã‚ã‚‹æ„å‘³ã§ã‚‚æœ¬è¨˜äº‹ã‚’åŸ·ç­†ã—ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

æœ¬è¨˜äº‹ã§ã¯ã€Web Audio API ã¨ React ã‚’ä½¿ã£ãŸç°¡å˜ãªã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ã€ãã®ä»•çµ„ã¿ã‚’å­¦ã‚“ã§ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚

:::message
èª¤è§£ãŒãªã„ã‚ˆã†ã«ç´°ãã—ã¦ãŠãã¨ã€ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ã‚¢ãƒ—ãƒªã¨å¼Šç¤¾æ¥­å‹™ã«ç›´æ¥é–¢ä¿‚ã¯ã”ã–ã„ã¾ã›ã‚“ã€‚ã‚ãã¾ã§ã€ç­†è€…ã®èˆˆå‘³ã¨Web Audio API ã®å­¦ç¿’ã®ãŸã‚ã®ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½œæˆã—ãŸå½¢ã¨ãªã‚Šã¾ã™ğŸ™‡â€â™‚ï¸
:::

## Web Audio API

MDN Web Docs ã® [Web Audio API](https://developer.mozilla.org/ja/docs/Web/API/Web_Audio_API) ã®ãƒšãƒ¼ã‚¸ã‚’è¦‹ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«èª¬æ˜ã•ã‚Œã¦ã„ã¾ã™ã€‚

> ã‚¦ã‚§ãƒ–ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª API ã¯ã‚¦ã‚§ãƒ–ä¸Šã§éŸ³å£°ã‚’æ‰±ã†ãŸã‚ã®å¼·åŠ›ã§å¤šæ©Ÿèƒ½ãªã‚·ã‚¹ãƒ†ãƒ ã‚’æä¾›ã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šé–‹ç™ºè€…ã¯éŸ³æºã‚’é¸æŠã—ãŸã‚Šã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’åŠ ãˆãŸã‚Šã€è¦–è¦šåŠ¹æœã‚’åŠ ãˆãŸã‚Šã€ãƒ‘ãƒ³ãƒ‹ãƒ³ã‚°ãªã©ã®ç‰¹æ®ŠåŠ¹æœã‚’é©ç”¨ã—ãŸã‚Šã€ä»–ã«ã‚‚ãŸãã•ã‚“ã®ã„ã‚ã„ã‚ãªã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

### ä½¿ã„æ–¹ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
ä¸Šè¨˜ãƒšãƒ¼ã‚¸ã«ã‚‚è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ãŒã€

1. Audio Context ã‚’ä½œæˆã™ã‚‹
2. ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã€ã‚¹ãƒˆãƒªãƒ¼ãƒ ã®éŸ³æºï¼ˆSource Nodeï¼‰ã‚’ä½œæˆã™ã‚‹
3. éŸ³å£°ã‚’åŠ å·¥ã™ã‚‹ãƒãƒ¼ãƒ‰ï¼ˆEffect Nodeï¼‰ã‚’ä½œæˆã™ã‚‹
4. éŸ³å£°ã®å‡ºåŠ›å…ˆï¼ˆDestination Nodeï¼‰ã‚’ä½œæˆã™ã‚‹
5. å„ãƒãƒ¼ãƒ‰ã‚’æ¥ç¶šã™ã‚‹

ã¨ã„ã†æµã‚Œã«ãªã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã¯ã€Web Audio API ã®å…¨ä½“ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ãªã‚Šã¾ã™ã€‚

![Web Audio API ã®ã‚¤ãƒ¡ãƒ¼ã‚¸](/images/web_audio_api.drawio.png)

### å„ãƒ–ãƒ©ã‚¦ã‚¶ã®å¯¾å¿œçŠ¶æ³

Web Audio API ã®åŸºæœ¬çš„ãªæ©Ÿèƒ½ç¯„å›²ã§ã‚ã‚Œã°ã€ãƒ¢ãƒã‚¤ãƒ«ãƒ–ãƒ©ã‚¦ã‚¶ã‚‚å«ã‚ã€ã»ã¨ã‚“ã©ã®ãƒ¢ãƒ€ãƒ³ãƒ–ãƒ©ã‚¦ã‚¶ã§åˆ©ç”¨ã§ããã†ã§ã™ã€‚  
è©³ç´°ã¯ã€[MDNãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://developer.mozilla.org/ja/docs/Web/API/Web_Audio_API#%E3%83%96%E3%83%A9%E3%82%A6%E3%82%B6%E3%83%BC%E3%81%AE%E4%BA%92%E6%8F%9B%E6%80%A7)ã§ç¢ºèªã§ãã¾ã™ã€‚

## ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®ä½œæˆã‚’é€šã—ã¦å­¦ã¶

ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®ç”»é¢ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚

![ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®ç”»é¢ã‚¤ãƒ¡ãƒ¼ã‚¸](/images/react_simple_synthesizer.png)

ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã®å®Œæˆç‰ˆãƒ‡ãƒ¢ã¯ã€ä»¥ä¸‹ãƒªãƒ³ã‚¯ã§ã”è¦§ã„ãŸã ã‘ã¾ã™ã€‚  
https://react-simple-synthesizer.vercel.app/

ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ã€GitHubã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚  
https://github.com/plumchang/react-simple-synthesizer

ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã§ã¯ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

- éŸ³æ³¢å½¢ã®é¸æŠï¼ˆã‚µã‚¤ãƒ³æ³¢ã€çŸ©å½¢æ³¢ãªã©ï¼‰
- å‘¨æ³¢æ•°ã®èª¿æ•´
  - éŸ³éšãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€éŸ³éšã¨ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã®é¸æŠ
- éŸ³é‡ã®èª¿æ•´
- ADSRã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ã®é©ç”¨
- ãƒªãƒãƒ¼ãƒ–ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®è¿½åŠ 

ï¼ˆä½™è«‡ã§ã™ãŒã€æœ¬ã‚µãƒ³ãƒ—ãƒ«ã‚µãƒ—ãƒªã¯ã€ã»ã¼ã»ã¼ Vercelã®ç”ŸæˆAIã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚‹ v0 ã‚’ä½¿ã£ã¦ä½œæˆã—ã¦ã„ã¾ã™ã€‚ï¼‰

### ã‚·ãƒ³ãƒ—ãƒ«ãªéŸ³ã‚’é³´ã‚‰ã—ã¦ã¿ã‚‹
ã¾ãšã¯ã€åŸºæœ¬çš„ãªã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ã‚µã‚¤ãƒ³æ³¢ã‚’é³´ã‚‰ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

#### OscillatorNodeã®ä½œæˆ

`OscillatorNode`ã¯ã€ç‰¹å®šã®æ³¢å½¢ã§éŸ³ã‚’ç”Ÿæˆã™ã‚‹ãƒãƒ¼ãƒ‰ã§ã™ã€‚

```typescript
// AudioContextã®ä½œæˆ
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

// OscillatorNodeã®ä½œæˆ
const oscillator = audioContext.createOscillator();
```

- ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ãƒ‰ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚µã‚¤ãƒ³æ³¢ï¼ˆsine waveï¼‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚

#### GainNodeã‚’ä½¿ã£ãŸéŸ³é‡èª¿æ•´

éŸ³é‡ã‚’èª¿æ•´ã™ã‚‹ãŸã‚ã«`GainNode`ã‚’ä½œæˆã—ã¾ã™ã€‚

```typescript
// GainNodeã®ä½œæˆ
const gainNode = audioContext.createGain();

// åˆæœŸéŸ³é‡ã®è¨­å®š
gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
```

- `gainNode.gain.setValueAtTime`ã‚’ä½¿ã£ã¦ã€éŸ³é‡ã‚’è¨­å®šã—ã¾ã™ã€‚
  - ç¬¬ä¸€å¼•æ•°ã¯éŸ³é‡ã§ã€0.0ã‹ã‚‰1.0ã®ç¯„å›²ã§æŒ‡å®šã—ã¾ã™ã€‚
  - ç¬¬äºŒå¼•æ•°ã¯æ™‚é–“ã§ã€`audioContext.currentTime`ã‚’æŒ‡å®šã™ã‚‹ã¨ã€å³åº§ã«éŸ³é‡ãŒå¤‰æ›´ã•ã‚Œã¾ã™ã€‚

#### ãƒãƒ¼ãƒ‰ã®æ¥ç¶š

ä½œæˆã—ãŸãƒãƒ¼ãƒ‰ã‚’æ¥ç¶šã—ã€æœ€çµ‚çš„ã«éŸ³å£°ã‚’å‡ºåŠ›ã—ã¾ã™ã€‚

```typescript
// ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å‡ºåŠ›ã‚’ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã«æ¥ç¶š
oscillator.connect(gainNode);
// ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã®å‡ºåŠ›ã‚’ã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ãªã©ã®è¦å®šã®å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹ã«æ¥ç¶š
gainNode.connect(audioContext.destination);
```

#### éŸ³ã‚’é³´ã‚‰ã™

æœ€å¾Œã«ã€ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’é–‹å§‹ã—ã¦éŸ³ã‚’é³´ã‚‰ã—ã¾ã™ã€‚

```typescript
// ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®é–‹å§‹
oscillator.start();

// ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®åœæ­¢
oscillator.stop();
```

#### ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å‘¨æ³¢æ•°ã®å¤‰æ›´

ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®å‘¨æ³¢æ•°ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€éŸ³ç¨‹ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚

```typescript
oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
```

- `oscillator.frequency.setValueAtTime`ã‚’ä½¿ã£ã¦ã€éŸ³é‡ã‚’è¨­å®šã—ã¾ã™ã€‚
  - ç¬¬ä¸€å¼•æ•°ã¯å‘¨æ³¢æ•°ã§ã™ã€‚
  - ç¬¬äºŒå¼•æ•°ã¯æ™‚é–“ã§ã€`audioContext.currentTime`ã‚’æŒ‡å®šã™ã‚‹ã¨ã€å³åº§ã«éŸ³é‡ãŒå¤‰æ›´ã•ã‚Œã¾ã™ã€‚

#### ã“ã“ã¾ã§ã®ã‚µãƒ³ãƒ—ãƒ«

@[codesandbox](https://codesandbox.io/embed/y2n84w?view=editor+%2B+preview&module=%2Fsrc%2FReactSimpleSynthesizer1.tsx)


### æ³¢å½¢ã®ç¨®é¡ã®å¤‰æ›´

ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®æ³¢å½¢ã‚’å¤‰æ›´ã™ã‚‹ã«ã¯ã€`oscillator.type`ã‚’å¤‰æ›´ã—ã¾ã™ã€‚  
æ³¢å½¢ã®ç¨®é¡ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€éŸ³ã®é³´ã‚Šæ–¹ãŒå¤‰ã‚ã‚Šã¾ã™ã€‚

```typescript
oscillator.type = 'square'; // "sine" | "square" | "sawtooth" | "triangle"
```

#### ã“ã“ã¾ã§ã®ã‚µãƒ³ãƒ—ãƒ«

æ³¢å½¢ã®ç¨®é¡ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚  
ã‚µã‚¤ãƒ³æ³¢ã®ä»–ã«ã€çŸ©å½¢æ³¢ï¼ˆsquareï¼‰ã€é‹¸æ­¯çŠ¶æ³¢ï¼ˆsawtoothï¼‰ã€ä¸‰è§’æ³¢ï¼ˆtriangleï¼‰ã‚’é¸æŠã§ãã¾ã™ã€‚  
å°‘ã€…è€³éšœã‚Šã«èã“ãˆã‚‹å¯èƒ½æ€§ã‚‚ã‚ã‚‹ãŸã‚ã€æ³¨æ„ã—ã¦ãã ã•ã„ğŸ™

@[codesandbox](https://codesandbox.io/embed/73q2cd?view=editor+%2B+preview&module=%2Fsrc%2FReactSimpleSynthesizer2.tsx)

### éŸ³éšã®é¸æŠ

ã“ã‚Œã¾ã§ã¯å‘¨æ³¢æ•°ã‚’ç›´æ¥æŒ‡å®šã—ã¦éŸ³ã‚’é³´ã‚‰ã—ã¦ãã¾ã—ãŸãŒã€éŸ³æ¥½çš„ã«ã¯**éŸ³éšï¼ˆãƒãƒ¼ãƒˆï¼‰**ã¨**ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–**ã§éŸ³ç¨‹ã‚’æŒ‡å®šã§ãã‚‹ã¨ä¾¿åˆ©ã§ã™ã€‚ã“ã“ã§ã¯ã€éŸ³éšã¨ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã‚’é¸æŠã—ã¦éŸ³ã‚’é³´ã‚‰ã™æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

éŸ³éšã¨ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã‹ã‚‰å¯¾å¿œã™ã‚‹å‘¨æ³¢æ•°ã‚’è¨ˆç®—ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ä¸€èˆ¬çš„ã«ã€éŸ³éšã”ã¨ã®å‘¨æ³¢æ•°ã¯ä»¥ä¸‹ã®å¼ã§è¨ˆç®—ã§ãã‚‹ã‚ˆã†ã§ã™ã€‚

$$
\text{å‘¨æ³¢æ•°} = 440 \times 2^{\frac{n}{12}}
$$

ï¼ˆ $n$ ã¯åŸºæº–éŸ³ï¼ˆA4ã€440Hzï¼‰ã‹ã‚‰ã®åŠéŸ³ã®æ•°ã«ãªã‚Šã¾ã™ï¼‰

å‚è€ƒã¾ã§ã«ã€Wikipediaã®ãƒªãƒ³ã‚¯ã‚’è²¼ã£ã¦ãŠãã¾ã™ã€‚  
https://ja.wikipedia.org/wiki/%E5%B9%B3%E5%9D%87%E5%BE%8B

#### éŸ³éšã‹ã‚‰å‘¨æ³¢æ•°ã¸ã®å¤‰æ›

ä¸Šè¨˜ã®å¼ã‚’ä½¿ã£ã¦ã€éŸ³éšã¨ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã‚’å…¥åŠ›ã¨ã—ã¦ã€å¯¾å¿œã™ã‚‹å‘¨æ³¢æ•°ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ã‚’ä½œæˆã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```typescript
type Note = "C" | "C#" | "D" | "D#" | "E" | "F" | "F#" | "G" | "G#" | "A" | "A#" | "B";

const noteToFrequency = (note: Note, octave: number): number => {
  const notes: Note[] = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
  const baseFrequency = 440; // A4ã®å‘¨æ³¢æ•°
  const baseOctave = 4;
  const baseNoteIndex = notes.indexOf("A");

  const noteIndex = notes.indexOf(note);
  const semitoneDifference = (octave - baseOctave) * 12 + (noteIndex - baseNoteIndex);

  return baseFrequency * Math.pow(2, semitoneDifference / 12);
};
```

#### å‘¨æ³¢æ•°ã®æŒ‡å®š

è¨ˆç®—ã—ãŸå‘¨æ³¢æ•°ã‚’ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã«è¨­å®šã™ã‚Œã°ã€é¸æŠã—ãŸéŸ³éšã¨ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã«åŸºã¥ã„ã¦éŸ³ã‚’é³´ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

```typescript
const frequency = noteToFrequency(selectedNote, selectedOctave);
oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
```

#### ã“ã“ã¾ã§ã®ã‚µãƒ³ãƒ—ãƒ«

ä»¥ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã€éŸ³éšã¨ã‚ªã‚¯ã‚¿ãƒ¼ãƒ–ã‚’é¸æŠã—ã¦éŸ³ã‚’é³´ã‚‰ã™ã“ã¨ãŒã§ãã¾ã™ã€‚

@[codesandbox](https://codesandbox.io/embed/6ply4f?view=editor+%2B+preview&module=%2Fsrc%2FReactSimpleSynthesizer3.tsx)


### ADSRã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ã¨ãƒªãƒãƒ¼ãƒ–ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®è¿½åŠ 

æœ€å¾Œã«ã€ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¨ã—ã¦ã€**ADSRã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—**ã¨**ãƒªãƒãƒ¼ãƒ–ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ**ã‚’è¿½åŠ ã—ã¦ã¿ã¾ã™ã€‚

#### ADSRã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—

**ADSR**ã¨ã¯ã€éŸ³ã®å¼·å¼±ã‚„æŒç¶šæ™‚é–“ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã€ä»¥ä¸‹ã®4ã¤ã®è¦ç´ ã‹ã‚‰æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

- **Attackï¼ˆã‚¢ã‚¿ãƒƒã‚¯ï¼‰**ï¼šéŸ³ãŒå‡ºå§‹ã‚ã¦ã‹ã‚‰æœ€å¤§éŸ³é‡ã«é”ã™ã‚‹ã¾ã§ã®æ™‚é–“
- **Decayï¼ˆãƒ‡ã‚£ã‚±ã‚¤ï¼‰**ï¼šæœ€å¤§éŸ³é‡ã‹ã‚‰æŒç¶šéŸ³é‡ã«æ¸›è¡°ã™ã‚‹ã¾ã§ã®æ™‚é–“
- **Sustainï¼ˆã‚µã‚¹ãƒ†ã‚¤ãƒ³ï¼‰**ï¼šæŒç¶šéŸ³é‡ï¼ˆéŸ³ãŒé³´ã£ã¦ã„ã‚‹é–“ã®éŸ³é‡ï¼‰
- **Releaseï¼ˆãƒªãƒªãƒ¼ã‚¹ï¼‰**ï¼šéµç›¤ã‚’é›¢ã—ã¦ã‹ã‚‰éŸ³ãŒæ¶ˆãˆã‚‹ã¾ã§ã®æ™‚é–“

![ADSRã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ã®ã‚¤ãƒ¡ãƒ¼ã‚¸](/images/adsr.drawio.png)

ã¤ã¾ã‚Šã¯ã€éŸ³é‡ã‚’æ™‚é–“ã«å¿œã˜ã¦å¤‰åŒ–ã•ã›ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã«ãªã‚Šã¾ã™ã€‚

##### ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ã®å®Ÿè£…

ã¾ãšã€ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ç”¨ã®`GainNode`ã‚’ä½œæˆã—ã¾ã™ã€‚

```typescript
// ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ç”¨ã®GainNodeã‚’ä½œæˆ
const envelopeGainNode = audioContext.createGain();
```

ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‹ã‚‰ã®å‡ºåŠ›ã‚’ã€ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ç”¨ã®`GainNode`ã«æ¥ç¶šã—ã€ãã®å¾Œã€éŸ³é‡èª¿æ•´ç”¨ã®`GainNode`ã«æ¥ç¶šã—ã¾ã™ã€‚

```typescript
oscillator.connect(envelopeGainNode);
envelopeGainNode.connect(gainNode);
gainNode.connect(audioContext.destination);
```

ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®šã™ã‚‹ãŸã‚ã«ã€`envelopeGainNode.gain`ã®å€¤ã‚’æ™‚é–“ã«å¿œã˜ã¦å¤‰åŒ–ã•ã›ã¾ã™ã€‚

```typescript
const now = audioContext.currentTime;

// Attackãƒ•ã‚§ãƒ¼ã‚º
envelopeGainNode.gain.setValueAtTime(0, now);
envelopeGainNode.gain.linearRampToValueAtTime(1, now + attack);

// Decayãƒ•ã‚§ãƒ¼ã‚º
envelopeGainNode.gain.linearRampToValueAtTime(sustainLevel, now + attack + decay);

// Sustainãƒ•ã‚§ãƒ¼ã‚ºã¯ãã®ã¾ã¾ç¶­æŒ

// Releaseãƒ•ã‚§ãƒ¼ã‚ºï¼ˆéŸ³ã‚’æ­¢ã‚ã‚‹ã¨ãï¼‰
const stopSound = () => {
  const now = audioContext.currentTime;
  envelopeGainNode.gain.cancelScheduledValues(now);
  envelopeGainNode.gain.setValueAtTime(envelopeGainNode.gain.value, now);
  envelopeGainNode.gain.linearRampToValueAtTime(0, now + release);
  oscillator.stop(now + release);
};
```

#### ãƒªãƒãƒ¼ãƒ–ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ

**ãƒªãƒãƒ¼ãƒ–**ã¯ã€éŸ³ã®æ®‹éŸ¿åŠ¹æœã‚’å†ç¾ã™ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã§ã™ã€‚

##### ConvolverNodeã®ä½¿ç”¨

ãƒªãƒãƒ¼ãƒ–ã‚’å®Ÿè£…ã™ã‚‹ãŸã‚ã«ã€`ConvolverNode`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

`ConvolverNode`ã¨ã¯
- éŸ³å£°ä¿¡å·ã« **ç•³ã¿è¾¼ã¿æ¼”ç®—ï¼ˆConvolutionï¼‰** ã‚’é©ç”¨ã™ã‚‹ãƒãƒ¼ãƒ‰ã§ã™ã€‚
- å…¥åŠ›ä¿¡å·ã¨**ã‚¤ãƒ³ãƒ‘ãƒ«ã‚¹ãƒ¬ã‚¹ãƒãƒ³ã‚¹**ã‚’åˆæˆã—ã¾ã™ã€‚

ã‚¤ãƒ³ãƒ‘ãƒ«ã‚¹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ã¯
- ç‰¹å®šã®ç©ºé–“ã‚„æ©Ÿå™¨ã®éŸ³éŸ¿ç‰¹æ€§ã‚’è¡¨ç¾ã—ãŸéŸ³å£°ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚
- ç¬é–“çš„ãªéŸ³ï¼ˆãƒ‘ãƒ«ã‚¹éŸ³ï¼‰ã«å¯¾ã—ã¦ã©ã®ã‚ˆã†ã«åå¿œã™ã‚‹ã‹ã‚’ç¤ºã—ã¾ã™ã€‚

```typescript
// ConvolverNodeã®ä½œæˆ
const convolverNode = audioContext.createConvolver();

// ã‚¤ãƒ³ãƒ‘ãƒ«ã‚¹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ç”Ÿæˆ
const createImpulseResponse = (duration, decay) => {
  const sampleRate = audioContext.sampleRate;
  const length = sampleRate * duration;
  // ã‚¹ãƒ†ãƒ¬ã‚ªãƒãƒ£ãƒ³ãƒãƒ«ï¼ˆ2ãƒãƒ£ãƒ³ãƒãƒ«ï¼‰ã®ãƒãƒƒãƒ•ã‚¡ã‚’ä½œæˆ
  const impulse = audioContext.createBuffer(2, length, sampleRate);
  const impulseL = impulse.getChannelData(0);
  const impulseR = impulse.getChannelData(1);

  for (let i = 0; i < length; i++) {
    const n = length - i;
    impulseL[i] = (Math.random() * 2 - 1) * Math.pow(n / length, decay);
    impulseR[i] = (Math.random() * 2 - 1) * Math.pow(n / length, decay);
  }
  return impulse;
};

// ã‚¤ãƒ³ãƒ‘ãƒ«ã‚¹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ConvolverNodeã«è¨­å®š
convolverNode.buffer = createImpulseResponse(2, 2);
```

- **duration**ï¼šã‚¤ãƒ³ãƒ‘ãƒ«ã‚¹ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®é•·ã•ï¼ˆç§’å˜ä½ï¼‰ã‚’æŒ‡å®šã—ã¾ã™ã€‚é•·ã„ã»ã©æ®‹éŸ¿ãŒé•·ããªã‚Šã¾ã™ã€‚
- **decay**ï¼šæ¸›è¡°ç‡ã‚’æŒ‡å®šã—ã¾ã™ã€‚å€¤ãŒå¤§ãã„ã»ã©æ®‹éŸ¿ãŒã‚†ã£ãã‚Šæ¸›è¡°ã—ã¾ã™ã€‚
- ã‚¹ãƒ†ãƒ¬ã‚ªãƒãƒ£ãƒ³ãƒãƒ«ï¼ˆå·¦ã¨å³ï¼‰ã«å¯¾ã—ã¦ã€ãƒ©ãƒ³ãƒ€ãƒ æ€§ã®ã‚ã‚‹æ¸›è¡°åŠ¹æœã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€è‡ªç„¶ãªæ®‹éŸ¿ã‚’å†ç¾ã—ã¾ã™ã€‚
  - `(Math.random() * 2 - 1) * Math.pow(n / length, decay)`ã«ã¤ã„ã¦
    - `Math.random() * 2 - 1`ã§ã€-1ã‹ã‚‰1ã®é–“ã®ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ï¼ˆãƒ›ãƒ¯ã‚¤ãƒˆãƒã‚¤ã‚ºï¼‰ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
    - `Math.pow(n / length, decay)`ã§ã€æ¸›è¡°ã•ã›ã¾ã™ã€‚

##### wetGainNodeã¨dryGainNodeã®èª¬æ˜

ãƒªãƒãƒ¼ãƒ–ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é©ç”¨ã™ã‚‹éš›ã€å…ƒã®éŸ³å£°ï¼ˆãƒ‰ãƒ©ã‚¤ä¿¡å·ï¼‰ã¨ãƒªãƒãƒ¼ãƒ–ãŒã‹ã‹ã£ãŸéŸ³å£°ï¼ˆã‚¦ã‚§ãƒƒãƒˆä¿¡å·ï¼‰ã‚’ãƒŸãƒƒã‚¯ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- `dryGainNodeï¼ˆãƒ‰ãƒ©ã‚¤ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ï¼‰`
  - å…ƒã®éŸ³å£°ä¿¡å·ã®éŸ³é‡ã‚’èª¿æ•´ã™ã‚‹ãŸã‚ã®ãƒãƒ¼ãƒ‰ã§ã™ã€‚
  - ãƒªãƒãƒ¼ãƒ–ã‚’é©ç”¨ã›ãšã€ç›´æ¥å‡ºåŠ›ã—ã¾ã™ã€‚

- `wetGainNodeï¼ˆã‚¦ã‚§ãƒƒãƒˆã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ï¼‰`
  - ãƒªãƒãƒ¼ãƒ–ãŒé©ç”¨ã•ã‚ŒãŸéŸ³å£°ä¿¡å·ã®éŸ³é‡ã‚’èª¿æ•´ã™ã‚‹ãŸã‚ã®ãƒãƒ¼ãƒ‰ã§ã™ã€‚
  - **ConvolverNode**ã‹ã‚‰å‡ºåŠ›ã•ã‚ŒãŸã‚¦ã‚§ãƒƒãƒˆä¿¡å·ã‚’å—ã‘å–ã‚Šã€éŸ³é‡ã‚’èª¿æ•´ã—ã¾ã™ã€‚

##### ãƒãƒ¼ãƒ‰ã®æ¥ç¶šã¨ãƒŸã‚­ã‚·ãƒ³ã‚°

ã“ã“ã¾ã§ã®ãƒãƒ¼ãƒ‰æ¥ç¶šã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚
![ãƒªãƒãƒ¼ãƒ–ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®ãƒãƒ¼ãƒ‰æ§‹æˆ](/images/reverb_node_structure.drawio.png)

```typescript
// ã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ãƒãƒ¼ãƒ‰ã‹ã‚‰ã®å‡ºåŠ›ã‚’ãƒ‰ãƒ©ã‚¤ã¨ã‚¦ã‚§ãƒƒãƒˆã«åˆ†å²
envelopeGainNode.connect(dryGainNode); // ãƒ‰ãƒ©ã‚¤ä¿¡å·
envelopeGainNode.connect(convolverNode); // ã‚¦ã‚§ãƒƒãƒˆä¿¡å·ï¼ˆãƒªãƒãƒ¼ãƒ–é©ç”¨ï¼‰

// ConvolverNodeã®å‡ºåŠ›ã‚’ã‚¦ã‚§ãƒƒãƒˆã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã«æ¥ç¶š
convolverNode.connect(wetGainNode);

// ãƒ‰ãƒ©ã‚¤ã¨ã‚¦ã‚§ãƒƒãƒˆã®ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã‚’ãƒã‚¹ã‚¿ãƒ¼ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã«æ¥ç¶š
dryGainNode.connect(gainNode);
wetGainNode.connect(gainNode);

// ãƒã‚¹ã‚¿ãƒ¼ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã‚’æœ€çµ‚å‡ºåŠ›ã«æ¥ç¶š
gainNode.connect(audioContext.destination);
```

##### ãƒªãƒãƒ¼ãƒ–é‡ã®èª¿æ•´

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªãƒãƒ¼ãƒ–ã®é‡ã‚’èª¿æ•´ã§ãã‚‹ã‚ˆã†ã«ã€ã‚¦ã‚§ãƒƒãƒˆã¨ãƒ‰ãƒ©ã‚¤ã®ã‚²ã‚¤ãƒ³ã‚’å¤‰æ›´ã—ã¾ã™ã€‚

```typescript
// ãƒªãƒãƒ¼ãƒ–é‡ã‚’èª¿æ•´ã™ã‚‹ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’å–å¾—
const reverbLevel = 0.5; // 0.0ã‹ã‚‰1.0ã®ç¯„å›²ã§æŒ‡å®š

// ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã®éŸ³é‡ã‚’è¨­å®š
wetGainNode.gain.setValueAtTime(reverbLevel, audioContext.currentTime);
dryGainNode.gain.setValueAtTime(1 - reverbLevel, audioContext.currentTime);
```

#### ã“ã“ã¾ã§ã®ã‚µãƒ³ãƒ—ãƒ«

ADSRã‚¨ãƒ³ãƒ™ãƒ­ãƒ¼ãƒ—ã¨ãƒªãƒãƒ¼ãƒ–ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¿½åŠ ã—ãŸã‚µãƒ³ãƒ—ãƒ«ã§ã™ã€‚

@[codesandbox](https://codesandbox.io/embed/8s8ptc?view=editor+%2B+preview&module=%2Fsrc%2FReactSimpleSynthesizer4.tsx)

ã“ã‚Œã§ã€UIãƒ©ã‚¤ãƒ–ãƒ©ãƒªä»¥å¤–ã¯ã€ä»¥ä¸‹ã®å®Œæˆç‰ˆãƒ‡ãƒ¢ã¨åŒã˜çŠ¶æ…‹ã«ãªã‚Šã¾ã—ãŸã€‚  
â€»UIãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼šCodeSandboxã®ã‚µãƒ³ãƒ—ãƒ«ã§ã¯`MUI`ã‚’ä½¿ç”¨ã—ã€ãƒ‡ãƒ¢ã§ã¯`shadcn/ui`ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
https://react-simple-synthesizer.vercel.app/

## ã¾ã¨ã‚

æœ€å¾Œã¾ã§ãŠèª­ã¿ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼  
æœ¬è¨˜äº‹ã§ã¯ã€Web Audio APIã‚’ä½¿ã£ã¦ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§æ§˜ã€…ãªéŸ³å£°å‡¦ç†ã‚’å®Ÿè¡Œã§ãã‚‹ã“ã¨ã‚’å­¦ã¹ã¾ã—ãŸã€‚  
Web Audio API ã«ã¯ã€æœ¬è¨˜äº‹ã§ã”ç´¹ä»‹ã—ãŸã‚‚ã®ä»¥å¤–ã«ã‚‚ã€æ§˜ã€…ãªéŸ³å£°å‡¦ç†æ©Ÿèƒ½ãŒå­˜åœ¨ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã®ã§ã€èˆˆå‘³ã‚’æŒãŸã‚ŒãŸæ–¹ã¯ã€ãœã² MDNã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç­‰ã§èª¿ã¹ã¦ã¿ã¦ãã ã•ã„ï¼

## å‚è€ƒ

https://developer.mozilla.org/ja/docs/Web/API/Web_Audio_API

https://github.com/plumchang/react-simple-synthesizer
